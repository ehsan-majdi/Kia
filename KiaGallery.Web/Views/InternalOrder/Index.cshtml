@{
    ViewBag.Title = "صفحه اصلی";
    List<KiaGallery.Web.Models.BranchListViewModel> branchList = ViewBag.BranchList;
    var user = BaseController.GetAuthenticatedUser();
    Layout = null;

}
<!DOCTYPE html>
<html dir="rtl">
<head>


    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سفارشات شعب - گالری کیا</title>
    <link href="~/Content/ios-switch-rtl.css" rel="stylesheet" />
    <link href="~/content/internal-order-page.css" rel="stylesheet" />
    <link href="~/content/fonts/fontawsome/font-awesome.css" rel="stylesheet" />
    <link href="~/content/fonts/sans/fontiran.css" rel="stylesheet" />
    <link href="~/content/bootstrap-rtl.min.css" rel="stylesheet" />
    <link href="~/content/chosen/chosen.css" rel="stylesheet" />
    <link href="~/content/chosen/imageSelect.css" rel="stylesheet" />
    <link href="~/Content/persian-datepicker.css" rel="stylesheet" />
    <link href="~/content/general.css" rel="stylesheet" />
    <link href="~/Content/froala/css/froala_style.css" rel="stylesheet" />
    <link href="~/Content/froala/css/froala_editor.css" rel="stylesheet" />
    <link href="~/content/site.css" rel="stylesheet" type="text/css" />
    <script src="~/scripts/modernizr-2.8.3.js"></script>
    <link href="~/Content/jqueryui/jquery-ui.css" rel="stylesheet" />
    <style>
        a {
            color: white
        }

            a:hover {
                color: white
            }

        th {
            text-align: center
        }

        td {
            text-align: center;
            vertical-align: middle !important
        }

        .description {
            text-align: right !important;
            background-color: #f2f2f2
        }

        .log {
            text-align: right !important;
            background-color: #ede6f7
        }

        .Reminder {
            color: red !important;
            background-color: white !important
        }

        .button-new {
            position: absolute;
            top: 16px;
            right: 5px
        }

        @@media screen and (min-width: 400px) and (max-width: 1600px) {
            .button-get {
                margin-right: 2px !important;
                margin-left: 1px !important;
                width: 162px !important;
                margin-top: 4px !important;
                height: 39px !important;
            }
        }

        .pagination {
            margin-right: 5px
        }

        @@media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            #menu > ul > li > a {
                font-size: 12px !important;
            }

            .edit-margin {
                margin-bottom: 10px
            }

            .searching-button {
                margin-bottom: 20px
            }
        }

        @@media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {

            .searching-button {
                margin-bottom: 20px
            }

            #menu-holder {
                margin-top: 50px !important
            }
        }
    </style>
</head>
<body>
    @*<div class="pull-left">
            <a href="/internalOrder/add" class="btn btn-success">
                <span class="fa fa-plus"></span>
            </a>
        </div>*@
    <br />

    <div class="text-center">
        <span class="Reminder"> <i style="font-size:20px;color:red" class="fa fa-exclamation-circle  Reminder"></i></span>
        <p>
            کاربر گرامی، کلیه مراحل سفارش از طریق سرویس <b>پیامک</b> به مشتری اطلاع رسانی می شود.
            لطفا در <b>تغییر</b> وضعیت  سفارش ها دقت نمایید.
        </p>

    </div>
    @if (User.IsInRole("admin") || User.IsInRole("internalOrderBranch"))
    {
        <a href="/internalOrder/add" class="button-new btn btn-success">
            <span class="fa fa-plus"></span>
            ثبت سفارش جدید
        </a>
    }
    <br />
    <div>
        <div class="form-inline col-md-12 col-lg-6 ">
            <div class="form-inline pull-right">
                @*<div class="form-group"><input id="Searching" class="form-control deleteVal text-center" type="text" placeholder="جستجو در شعبه @user.UserPlace" name="code" /></div>*@
                @*<button id="btnDeleteVal" class="btn btn-danger form-control">حذف فیلتر</button>*@
            </div>
            <div class="form-inline pull-right" style="margin-right:10px">
                @*<div class="form-group"><input id="Searching" class="form-control deleteVal text-center" type="text" placeholder="[--------- بارکد پیگیری ---------]" name="code" /></div>
                    <input type="button" class="change-status sendToTheBranch btn btn-primary" value="ارسال به دفتر مرکزی" data-status="8" data-confirm="آیا از تغییر وضعیت به ارسال به دفتر مرکزی اطمینان دارید؟" />*@
                <div class="form-group"><input style="width:250px" id="getlog" class="form-control deleteVal text-center col-md-12" type="text" placeholder="جستجو" name="term" /></div>
                <button id="btnGetLog" class="btn btn-info"><span><i class="fa fa-search"> </i></span></button>

                @*<div id="selctedCount" class="btn btn-default" style="display:none"></div>*@

            </div>

        </div>
        <div id="customerfilter" class="pull-left" style="top:38px;position: absolute;margin-right:26px;width: 202px;display: flex;">
            <h5 style="position: relative;top: 13px;left: 7px;">همه</h5>
            <div class="filter-item"><div class="checkbox ios-switch"><label><input class="chkCustomer" type="checkbox" name="notCustomer" value="true"><span id="customerfilter-title"></span></label></div></div>
            <h5 style="position: relative;top: 13px;left: 7px;">پرسنل کیا</h5>

        </div>
        @*<div class="col-lg-3 col-md-12 col-lg-offset-3 ">
                <div class="searching-button">
                    @if (User.IsInRole("admin") || User.IsInRole("InternalOrderBranch"))
                    {
                        <div class="row">
                            <div class="col-lg-12 col-md-6 btn-group text-center " id="palce-btn">
                                <a href="/internalOrder/sendToOffice" id="" class="btn btn-danger button-get"><span class="pull-right"><i class="fa fa-arrow-circle-up fa-22px"></i></span>&nbsp;ارسال به دفتر مرکزی</a>
                                <a href="/internalOrder/acceptfromoffice" id="" class="btn btn-success button-get" style="margin-right: 6px;"><span class="pull-right"><i class="fa fa-arrow-circle-down fa-22px"> </i></span>&nbsp;دریافت از دفتر مرکزی </a>
                            </div>
                        </div>

                    }

                    @if (User.IsInRole("admin") || User.IsInRole("InternalOrderOffice"))
                    {
                        <div class="row">
                            <div class="col-lg-12 col-md-6 btn-group text-center" id="palce-btn">
                                <a href="/internalOrder/sendtobranch" id="" class="btn btn-danger button-get" style="width:160px;margin-left:7px;margin-top: 7px;"><span class="pull-right"><i class="fa fa-arrow-circle-up fa-22px"></i></span>&nbsp;ارسال به شعبه</a>
                                <a href="/internalOrder/acceptfrombranch" id="" class="btn btn-success button-get" style="width:164px;margin-left:7px;margin-top:7px"><span class="pull-right"><i class="fa fa-arrow-circle-down fa-22px"> </i></span>&nbsp;دریافت از شعبه </a>
                            </div>
                        </div>
                    }

                </div>
            </div>*@
    </div>
    <br />
    <br />
    @if (User.IsInRole("admin") || User.IsInRole("internalOrderBranch"))
    {
        <div id="menu-holder" class="affix hidden-xs">
            <div id="menu">
                <ul>
                    <!--<li class="registered"><a class="chkStatus" data-id="5"><i class="fa fa-check"></i>&nbsp;ثبت شده</a></li>
                    <li class="processing"><a id="processing" class="chkStatus" data-id="7,8,9,10"><i class="fa fa-spinner"></i>&nbsp;پردازش</a></li>
                    <li class="readyForDeliver"><a class="chkStatus" data-id="0"><i class="fa fa-thumbs-up"></i>&nbsp;آماده تحویل</a></li>
                    <li class="pendingCustomer"><a class="chkStatus" data-id="3"><i class="fa fa-phone"></i>&nbsp;خبر میده</a></li>
                    <li class="noAnswer"><a class="chkStatus" data-id="4"><i class="fa fa-microphone-slash"></i>&nbsp;جواب نداد</a></li>
                    <li class="delivered"><a class="chkStatus" data-id="1"><i class="fa fa-shopping-bag"></i>&nbsp;تحویل شده</a></li>-->
                    @*<li class="kiaPersonnel"><a id="chkUserType"><i class="fa fa-user"></i>&nbsp;پرسنل کیا</a></li>*@
                    <!--<li class="cancel"><a class="chkStatus" data-id="2"><i class="fa fa-close"></i>&nbsp;لغو شده</a></li>
                    <li class="deleted"><a class="chkStatus" data-id="6"><i class="fa fa-trash"></i>&nbsp;حذف شده</a></li>-->
                    <li class="all"><a id="all">همه</a></li>
                </ul>
            </div>
        </div>
    }
    <br />
    <br />

    <div id="content">
    </div>

    <div id="modal-operation" class="modal" style="overflow-y: hidden;">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">عملیات</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="hiddenOrderId" />
                    @*<button id="btnReadyForDeliver" class="btn btn-primary btn-block">آماده تحویل</button>*@
                    <button id="btnNoAnswer" class="btn btn-primary btn-block">جواب نداد</button>
                    <button id="btnPendigCustomer" class="btn btn-primary btn-block">خبر میده</button>
                    <button id="btnSendBranch" class="btn btn-primary btn-block">ارسال</button>
                    <button id="btnSend" class="btn btn-success btn-block">تحویل به مشتری</button>
                    <button id="btnCancel" class="btn btn-danger btn-block">لغو</button>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-send" class="modal" style="overflow-y: hidden;">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">تحویل به مشتری</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>
                            تسویه حساب
                        </label>
                        <select id="cmbPonyUp" class="form-control" name="ponyUp">
                            <option value="">...</option>
                            <option value="true">تسویه شده</option>
                            <option value="false">تسویه نشده</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            نوع تحویل
                        </label>
                        <select id="cmbDeliveryType" class="form-control" name="deliveryType">
                            <option value="">...</option>
                            <option value="4">حضوری</option>
                            <option value="0">پیک</option>
                            <option value="2">پرسنل کیا</option>
                            <option value="3">پست</option>
                        </select>
                    </div>
                    <input style="display:none" class="form-control" id="txtDeliveredCustomerName" name="deliveredCustomerName" placeholder="نام" />
                    <input style="display:none" class="form-control" id="txtDeliveredCustomerPhone" name="deliveredCustomerPhone" placeholder="شماره تلفن" />
                </div>
                <div class="modal-footer">
                    <button id="btnSubmitSent" class="btn btn-primary" style="width: 100px;">ثبت</button>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-sendtobranch" class="modal" style="overflow-y: hidden;">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">ارسال</h4>
                </div>
                <div class="modal-body">

                    <label>
                        شعبه
                    </label>
                    <select id="cmbBranch" class="form-control" name="deliveredBranchId">
                        <option value="">...</option>
                    </select>

                </div>
                <div class="modal-footer">
                    <button id="btnSendCustomer" class="btn btn-primary" style="width: 100px;">ثبت</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-comment" class="modal" style="overflow-y: hidden;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">درج یادداشت</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="hiddenId" />
                    <textarea id="txtText" class="form-control" style="width: 100%; resize: vertical;" rows="4"></textarea>
                </div>
                <div class="modal-footer">
                    <button id="btnSetComment" class="btn btn-primary" style="width: 100px;">درج</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-status" class="modal" style="overflow-y: hidden;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">سوابق</h4>
                </div>
                <div class="modal-body">
                    <div id="content-status"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="modal-getLog" class="modal" style="overflow-y: hidden;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">سوابق</h4>
                </div>
                <div class="modal-body">
                    <div id="content-getLog"></div>
                </div>
            </div>
        </div>
    </div>

    @*<div id="modal-no-answer" class="modal" style="overflow-y: hidden;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">جواب نداد</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>تاریخ یادآوری</label>
                            <input id="hiddenRemindId" type="hidden" />
                            <input id="txtRemindDateNoAnswer" type="text" class="date form-control" readonly />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input id="btnSubmitNoAnswer" type="button" class="btn btn-primary" value="ثبت" style="width: 100px;" />
                    </div>
                </div>
            </div>
        </div>*@

    @*<div id="modal-pending-customer" class="modal" style="overflow-y: hidden;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">خبر میده</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>تاریخ یادآوری</label>
                            <input id="txtRemindDatePendingCustomer" type="text" class="date form-control" readonly (dateChange)="picker.close()" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input id="btnSubmitPendingCustomer" type="button" class="btn btn-primary" value="ثبت" style="width: 100px;" />
                    </div>
                </div>
            </div>
        </div>*@

    <script src="~/scripts/jquery-1.12.4.min.js"></script>
    <script src="~/scripts/bootstrap.min.js"></script>
    <script src="~/scripts/jsrender.js"></script>
    <script src="~/Scripts/fileupload/jquery.ui.widget.js"></script>
    <script src="~/Scripts/fileupload/jquery.fileupload.js"></script>
    <script src="~/scripts/chosen/chosen.jquery.js"></script>
    <script src="~/scripts/chosen/imageSelect.jquery.js"></script>
    <script src="~/Scripts/persianDate/persian-date.js"></script>
    <script src="~/Scripts/persianDate/persian-datepicker-0.4.5.js"></script>
    <script src="~/scripts/general.js"></script>
    <script src="~/scripts/validate.js"></script>
    <script src="~/scripts/numberOnly.js"></script>
    <script src="~/scripts/entity.js"></script>
    <script src="~/Scripts/froala/js/froala_editor.min.js"></script>
    <script src="~/Scripts/jqueryui/jquery-ui.js"></script>
    <script src="~/Scripts/jquery.elevatezoom.js"></script>

    <script type="text/javascript">

        function changeStatus(input, status, branchShoppingId, deliveredBranchId) {

            var params = {
                id: input,
                status: status,
                branchShoppingId: branchShoppingId,
                deliveredBranchId: deliveredBranchId

            };

            loader(true);
            $.post("/internalOrder/ChangeStatus", params, function (response) {
                loader(false);
                if (response.status == 200) {
                    location.reload();
                }

            });
        }
        function blinker() {
            $('.Reminder').fadeOut(1000);
            $('.Reminder').fadeIn(1000);
        }
        setInterval(blinker, 1000);
        $(window).on('hashchange', function () {
            getList();
        });
        $(window).scroll(function () {
            var windowScroll = $(window).scrollTop();
            if (windowScroll > 10) {
                $("#menu-holder").addClass("menu-holder-top0");
            }
            else {
                $("#menu-holder").removeClass("menu-holder-top0");
            }
        });


    $(document).ready(function () {
        $("#cmbDeliveryType").on("change", function () {
            if ($(this).val() == 4) {
                $("#txtDeliveredCustomerName").show();
                $("#txtDeliveredCustomerPhone").show();
            }
            else {
                $("#deliveredCustomerName").hide();
                $("#deliveredCustomerPhone").hide();
            }

        })
        $(document).on("change", ".chkCustomer", function (event) {
            if ($(this).prop("checked")) {
                var param = { notCustomer: true }
                manipulateParam(param, "page");
            }
            else {
                removeParam(["notCustomer", "page"]);

            }
        });
        $("#btnSendBranch").on("click", function (event) {
            $("#modal-operation").modal("hide");

            $("#modal-sendtobranch").modal("show");
        });

        $("#btnSendCustomer").on("click", function (event) {/*صفحه مودال مربوط به انتخاب شعبه توسط کاربر*/
            event.preventDefault();
            var orderId = $("#hiddenOrderId").val();
            var deliveredBranchId = $("#cmbBranch").val();
            var idList = $("#hiddenOrderId").val();

            loader(true);
            changeStatus(idList, 1, null, deliveredBranchId);

            //$.post("/internalOrder/changeStatus", { deliveredBranchId: deliveredBranchId, orderId: orderId }, function (response) {
            //    loader(false);
            //    if (response.status == 200) {
            //        callbackAlert(response.message, function () {
            //            $("#modal-operation").modal("hide");
            //            $("#modal-sendtobranch").modal("hide");
            //            location.reload();
            //        });
            //    }
            //    else {
            //        alert(response.message);
            //    }
            //});
        });
        loadRemoteSelect("#cmbBranch", "/branch/getbranch", null, "id", "name", "انتخاب شعبه ...", function () {

        });
        $(document).on("click", "#btnGetLog", function () {
            if ($("#getlog").val()) {
                var param = { term: $("#getlog").val() }
                manipulateParam(param, "page");
            }
            else
                removeParam("term");
            if (param != null && param != "") {
                $.get("/internalOrder/getLogHistory", param, function (response) {
                    if (response.status == 200) {
                        var data = response.data;
                        var template = $.templates("#template-getLog");
                        var htmlOutput = template.render(data);
                        $("#content-getLog").html(htmlOutput);
                        $("#modal-getLog").modal('show')
                    }
                    else {
                        alert(response.message);
                    }
                    loader(false);
                });

            }

        });
        $(document).on("keyup", "input[name=term]", function () {
            if ($("#getlog").val()) {
                var param = { term: $("#getlog").val() }
                manipulateParam(param, "page");
            }
            else
                removeParam("term");
            if (param != null && param != "") {
                $.get("/internalOrder/getLogHistory", param, function (response) {
                    if (response.status == 200) {
                        var data = response.data;
                        var template = $.templates("#template-getLog");
                        var htmlOutput = template.render(data);
                        $("#content-getLog").html(htmlOutput);
                        $("#modal-getLog").modal('show')
                    }
                    else {
                        alert(response.message);
                    }
                    loader(false);
                });

            }
        });

        $("#Searching").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#TableSearch tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
        $("#btnDeleteVal").on("click", function () {
            $(".deleteVal").val("")
            removeParam(["userId"]);


        });
        $("#all").on("click", function (event) {
            event.preventDefault();
            //defaultEntity.status = null;
            //defaultEntity.userType = null;
            manipulateParam({ page: 0 }, ["userType", "status"]);

        });
        //$("#processing").on("click", function (event) {
        //    defaultEntity.userType = null;
        //    defaultEntity.status = null;
        //    manipulateParam({ status: $(this).attr("data-id") }, ["userType", "status" , "page"]);

        //});

        $(".chkStatus").on("click", function () {
            defaultEntity.userType = null;
            manipulateParam({ status: $(this).attr("data-id").split(',') }, ["page"]);
        });

        //$("#chkUserType").on("click", function () {
        //    defaultEntity.status = null;
        //    manipulateParam({ userType: 1 }, ["page", "status"]);
        //});

        $(".date").pDatepicker({
            format: 'YYYY/MM/DD',
            autoClose: true,
        });
        $(".date").val("");


        $("#spnReminderCount").on("click", function (event) {
            event.preventDefault();
            if (getParam()["remind"] == undefined || getParam()["remind"] == "false") {
                setParam("remind", true);
            }
            else {
                setParam("remind", false);
            }
        });

        $("#lblRemind").on("click", function () {
            setParam("remind", false);
        });

        $(document).on("change", "#cmbUser", function (event) {
            var code = event.which; // recommended to use e.which, it's normalized across browsers
            if (code == 13) event.preventDefault();
            setAllParam();
        });

        $(document).on("click", "#getlog", function () {
            if ($("#getlog").val()) {
                var param = { term: $("#getlog").val() }
                manipulateParam(param, "page");
            }
            else
                removeParam("term");
        })

        $("#btnSetComment").on("click", function (event) {
            var params = {
                id: $("#hiddenId").val(),
                comment: $("#txtText").val()
            }

            if (!params.id || !params.comment) {
                alert("فرم به درستی تکمیل نشده است.");
                return;
            }

            loader(true);
            $.post("/internalOrder/addComment", params, function (response) {
                loader(false);
                if (response.status == 200) {
                    callbackAlert(response.message, function () {
                        $("#modal-comment").modal('hide');
                        getList();
                    });
                }
                else {
                    alert(response.message);
                }
            });
        });

        $("#btnSend").on("click", function (event) {
            event.preventDefault();
            $("#cmbPonyUp").val($("#cmbPonyUp option:first").val());
            $("#cmbDeliveryType").val($("#cmbDeliveryType option:first").val());
            $("#branchGroup").addClass("hidden");
            $("#modal-operation").modal("hide");
            $("#modal-send").modal("show");
        });

        $("#btnNoAnswer").on("click", function (event) {
            event.preventDefault();
            $("#txtRemindDateNoAnswer").val("");
            $("#modal-operation").modal("hide");
            $("#modal-no-answer").modal("show");
        });

        //$("#btnCancel").on("click", function (event) {
        //    event.preventDefault();
        //    confirmMessage("آیا از لغو سفارش اطمینان دارید؟", function () {
        //        $.post("/internalOrder/readyForDeliver", { orderId: $("#hiddenOrderId").val() }, function (response) {
        //            loader(false);
        //            if (response.status == 200) {
        //                callbackAlert(response.message, function () {
        //                    $("#modal-operation").modal("hide");
        //                    getList();
        //                })
        //            }
        //            else {
        //                alert(response.message);
        //            }
        //        });
        //    });
        //});

        $("#btnPendigCustomer").on("click", function (event) {
            event.preventDefault();
            $("#txtRemindDatePendingCustomer").val("");
            $("#modal-operation").modal("hide");
            $("#modal-pending-customer").modal("show");
        });

        $("#btnNoAnswer").on("click", function (event) {
            event.preventDefault();

            var entity = {
                orderId: $("#hiddenOrderId").val(),
                date: $("#txtRemindDateNoAnswer").val()
            };

            loader(true);
            $.post("/internalOrder/reminderNoAnswer", entity, function (response) {
                loader(false);
                if (response.status == 200) {
                    callbackAlert(response.message, function () {
                        $("#modal-no-answer").modal("hide");
                        getList();
                    })
                }
                else {
                    alert(response.message);
                }
            });
        });
        $("#btnPendigCustomer").on("click", function (event) {
            event.preventDefault();

            var entity = {
                orderId: $("#hiddenOrderId").val(),
                date: $("#txtRemindDatePendingCustomer").val()
            };

            loader(true);
            $.post("/internalOrder/reminderAnswered", entity, function (response) {
                loader(false);
                if (response.status == 200) {
                    callbackAlert(response.message, function () {
                        getList();
                    })
                }
                else {
                    alert(response.message);
                }
            });
        });

        $("#btnPendigCustomer").on("click", function (event) {
            event.preventDefault();

            var entity = {
                orderId: $("#hiddenOrderId").val(),
                date: $("#txtRemindDatePendingCustomer").val()
            };

            loader(true);
            $.post("/internalOrder/pendingCustomer", entity, function (response) {
                loader(false);
                if (response.status == 200) {
                    callbackAlert(response.message, function () {
                        getList();
                    })
                }
                else {
                    alert(response.message);
                }
            });
        });

        $("#cmbDeliveryType").on("change", function () {
            if (parseInt($(this).val()) == 1) {
                $("#branchGroup").removeClass("hidden");
            }
            else {
                $("#branchGroup").addClass("hidden");
            }
        });

        $("#btnSubmitSent").on("click", function (event) {
            event.preventDefault();

            var entity = getEntity("#modal-send");

            entity.orderId = $("#hiddenOrderId").val();

            if (entity.ponyUp == "") {
                alert("انتخاب تسویه اجباری است.")
                return;
            }

            if (entity.deliveryType == "") {
                alert("انتخاب محل تحویل اجباری است.")
                return;
            }

            if (parseInt(entity.deliveryType) == 1 && entity.deliveredBranchId == "") {
                alert("انتخاب شعبه اجباری است.")
                return;
            }

            loader(true);
            $.post("/internalOrder/delivered", entity, function (response) {
                loader(false);
                if (response.status == 200) {
                    callbackAlert(response.message, function () {
                        $("#modal-send").modal("hide");
                        getList();
                    })
                }
                else {
                    alert(response.message);
                }
            });
        });

        $("#btnCancel").on("click", function (event) {
            event.preventDefault();

            var id = $("#hiddenOrderId").val()

            confirmMessage("آیا از لغو سفارش اطمینان دارید؟", function () {
                loader(true);
                $.post("/internalOrder/cancel/" + id, function (response) {
                    loader(false);
                    if (response.status == 200) {
                        callbackAlert(response.message, function () {
                            $("#modal-operation").modal("hide");
                            getList();
                        });
                    }
                    else {
                        alert(response.message);
                    }
                });
            });
        });

        $(document).on("click", ".edit", function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            confirmMessage("آیا از ویرایش سفارش اطمینان دارید؟", function () {
                document.location = "/internalOrder/edit/" + id;
            });
        });

        $(document).on("click", ".delete", function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            confirmMessage("آیا از حذف سفارش اطمینان دارید؟", function () {
                $.post("/internalOrder/delete/" + id, function (response) {
                    alert(response.message);
                    if (response.status == 200) {
                        getList();
                    }
                });
            });
        });

        $(document).on("click", ".setLog", function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            $("#hiddenId").val(id);
            $("#txtText").val("");
            $("#modal-comment").modal('show');
        });

        $(document).on("click", ".operation", function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            $("#hiddenOrderId").val(id);
            $("#modal-operation").modal('show');
        });

        $(document).on("click", ".status-log-history", function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            loader(true);
            $.get("/internalOrder/getStatusLogHistory/" + id, function (response) {
                loader(false);
                if (response.status == 200) {
                    var data = response.data;
                    var template = $.templates("#template-status");
                    var htmlOutput = template.render(data);
                    $("#content-status").html(htmlOutput);
                    $("#modal-status").modal("show");
                }
                else {
                    alert(response.message);
                }
            });
        });

        $(document).on("click", ".page-number", function (event) {
            event.preventDefault();
            var page = parseInt($(this).html()) - 1;
            setParam("page", page);
        });

        if (getParam()["page"]) {
            getList();
        }
        else {
            setParam("page", 0);
        }

    });

        function getList() {
            updateForm();

        var defaultEntity = {
            page: 0,
            count: 500,
            text: null,
            //status: [],
            userType: null,
            name: null,
            phoneNumber: null,
            title: null,
            deposit: null,
            barcode: null,
            user: null,
            term: null,
            process: null,
            branchId: '@ViewBag.BranchId'
        }
        var urlParams = getParam();
        var params = $.extend({},defaultEntity, urlParams);

        loader(true);
        $.post("/internalOrder/search", params, function (response) {
            if (response.status == 200) {
                var data = response.data;
                var template = $.templates("#template");
                var htmlOutput = template.render(data);
                $("#content").html(htmlOutput);
                $('[data-toggle="tooltip"]').tooltip({ 'placement': 'top' });

                $(".zoomImage").elevateZoom({ zoomWindowPosition: 1, zoomWindowWidth: 250, zoomWindowHeight: 250 });


                $(".html").each(function () {
                    if ($(this).html().indexOf("جواب") >= 0) {
                        $(this).parent("td").addClass("Reminder")

                    }
                })
                updateForm();
            }
            else {
                alert(response.message);
            }
            loader(false);
            //$("[data-toggle=tooltip]").tooltip();
        });
    }
    function updateForm() {
        var params = getParam();
        $("#menu li").removeClass("active");
        if (params.status && params.status >= 0)
            $("#menu li a[data-id=" + params.status + "]").closest("li").addClass("active");
        else {
            if (params.userType) {
                $("#menu li.kiaPersonnel").addClass("active");
            }
            if (params.status) {
                $("#menu li a#processing").closest("li").addClass("active");
            }
            else {
                $("#menu li a#all").closest("li").addClass("active");
            }
        }

        if (params.remind == "true") {
            $("#searchBar").addClass("hidden");
            $("#remindBar").removeClass("hidden");
        }
        else {
            $("#searchBar").removeClass("hidden");
            $("#remindBar").addClass("hidden");
        }
    }


    </script>
    <script id="template" type="text/x-jsrender">
        {{if list.length > 0}}
        <table class="table">
            <thead>
                <tr class="text-center">


                    <th>تاریخ</th>
                    @*<th>تاریخ درج بارکد</th>*@
                    <th>نام مشتری</th>
                    <th>تلفن</th>
                    <th>نوع سفارش</th>
                    <th>بیعانه</th>
                    <th>نام محصول</th>
                    <th>کد سایت</th>
                    <th>کد کارگاه</th>
                    <th>تصویر</th>
                    <th>کد پیگیری</th>
                    @*<th class="hidden-sm hidden-md">بارکد</th>*@
                    @*<th>وضعیت</th>*@
                    @*<th class="hidden-sm hidden-md">شعبه تحویل گیرنده</th>*@
                    <th class="hidden-sm hidden-md">شعبه</th>
                    <th class="hidden-sm hidden-md">کاربر</th>
                    @*<th class="hidden-sm hidden-md">نوع مشتری</th>*@


                    @*<th class="icon-col">ارسال</th>
                        <th class="icon-col">لغو</th>*@
                </tr>
            </thead>
            <tbody id="TableSearch">
                {{for list}}
                <tr style="border-top: solid 1px silver">

                    <td>{{:date}}</td>
                    <td>{{:name}}</td>
                    <td>{{:phoneNumber}}</td>
                    <td>{{:orderTypeFromTitle}}</td>
                    <td>{{:deposit}}</td>
                    {{if productId > 0}}
                    <td>{{:productTitle}}</td>
                    {{else}}
                    <td>{{:title}}</td>
                    {{/if}}
                    <td>
                        {{if siteCode != null}}
                        {{:siteCode}}
                        {{else}}
                        -
                        {{/if}}
                    </td>
                    <td>
                        {{if bookCode != null}}
                        {{:bookCode}}
                        {{else}}
                        -
                        {{/if}}
                    </td>
                    {{for detail}}
                    <td style="">
                        {{if fileName == null && image != null}}
                        <img class="zoomImage" src="/image/internalOrderDetail/500x500/{{:image}}" width="90px" data-zoom-image="/image/internalOrderDetail/500x500/{{:image}}" />
                        {{/if}}

                        {{if fileName != null && image == null}}
                        <img class="zoomImage" src="/image/product/500x500/{{:fileName}}" width="90px" data-zoom-image="/image/product/500x500/{{:fileName}}" />
                        {{/if}}

                        {{if fileName == null && image == null}}
                        <img class="" src="/Content/Image/logokia.png" width="90px" />
                        {{/if}}
                    </td>
                    {{/for}}
                    <td>
                        @*{{if status == "ارسال به دفتر مرکزی" || status == "تحویل از شعبه" || status == "ارسال به شعبه" || status == "تحویل از دفتر مرکزی" }}
                            ---
                            {{else}}
                            {{/if}}*@
                        {{:trackCode}}
                    </td>

                    @*<td class="hidden-sm hidden-md">{{:barcode}}</td>*@
                    <!--<td>
                    {{if statusCode == 1 && ponyUp != null}}
                    {{if ponyUp}}
                    <span class="text-success" style="vertical-align: middle;">تسویه شده-</span>
                    {{else}}
                    <span class="text-danger" style="vertical-align: middle;">تسویه نشده-</span>
                    {{/if}}
                    <span style="vertical-align: middle;">
                        {{/if}}
                        {{:status}}
                        {{if statusCode == 1 && deliverTypeTitle && statusCode != 6}}
                        به
                        {{/if}}
                        {{if deliverType == 0 && statusCode != 6}}
                        <span class=" text-success" style="vertical-align: middle;" title="پیک">پیک</span>
                        {{/if}}
                        {{if deliverType == 1 && statusCode != 6}}
                        <span class=" text-" style="vertical-align: middle;color:#ff6a00" title="شعبه">شعبه</span>
                        {{:branchName}}
                        {{/if}}
                        {{if deliverType == 2 && statusCode != 6}}
                        <span class="" style="vertical-align: middle;color:#700d0d" title="پرسنل کیا">پرسنل کیا</span>
                        {{/if}}
                        {{if deliverType == 3 && statusCode != 6}}
                        <span class=" text-primary" style="vertical-align: middle;" title="پست">پست</span>
                        {{/if}}
                        {{if status == "جواب نداد"}}-->
                    @*({{:noAnswerCount}})*@
                    <!--{{/if}}
                        </span>
                    </td>-->
                    <td class="hidden-sm">
                        {{if branchName}}
                        <span class="" style="vertical-align: middle;color:#ff6a00" title="شعبه">شعبه</span>
                        {{:branchName}}
                        {{/if}}
                    </td>
                    <td class="hidden-sm hidden-md"><span class="userColor" style="background-color:{{:userColor}}"></span> {{:user}}</td>
                    @*<td class="hidden-sm hidden-md">{{:multiOrder}}</td>*@
                    @*<td class="hidden-sm hidden-md">{{:orderedBranchName}}</td>*@
                    <td class="hidden-sm hidden-md">
                        {{:userType}}
                    </td>
                    @if (User.IsInRole("admin"))
                    {
                        <td class="txt-al-c">
                            <button class="delete btn btn-default btn-xs" data-toggle="tooltip" title="حذف" data-title="حذف" data-id="{{:id}}"><span class="fa fa-close"></span></button>
                        </td>

                        <td class="txt-al-c">

                            <span data-placement="top" data-toggle="tooltip" title="ویرایش">
                                <button class="edit btn btn-default btn-xs" data-id="{{:id}}"><span class="fa fa-pencil"></span></button>
                            </span>
                        </td>

                        <td class="">
                            <a href="/internalOrder/ordersheet/{{:id}}" class="btn btn-default btn-xs" data-toggle="tooltip" title="چاپ" data-title="چاپ"><i class="fa fa-print" aria-hidden="true"></i></a>
                        </td>
                        @*<td class="txt-al-c">
                                <button class="operation btn btn-default btn-xs" data-toggle="tooltip" title="عملیات" data-title="عملیات" data-id="{{:id}}"><span class="fa fa-cogs"></span></button>
                            </td>
                            <td class="txt-al-c hidden-sm hidden-md">
                                <button class="setLog btn btn-default btn-xs" data-toggle="tooltip" title="درج توضیحات" data-title="درج توضیحات" data-id="{{:id}}"><span class="fa fa-comment"></span></button>
                            </td>*@
                        <td>
                            <button class="delete btn btn-default btn-xs" data-toggle="tooltip" title="حذف" data-title="حذف" data-id="{{:id}}"><span class="fa fa-close"></span></button>
                        </td>
                        <td class="txt-al-c">
                            <button class="status-log-history btn btn-default btn-xs" data-toggle="tooltip" title="سوابق" data-title="سوابق" data-id="{{:id}}"><span class="fa fa-file"></span></button>
                        </td>
                        <td class="txt-al-c">
                            <a href="/internalOrder/view/{{:id}}" class="btn btn-default btn-xs" data-toggle="tooltip" title="مشاهده" data-title="مشاهده"><i class="fa fa-eye" aria-hidden="true"></i></a>
                        </td>
                    }

                    @if (!User.IsInRole("admin"))
                    {
                        <text>
                            <td>
                                <span data-placement="top" data-toggle="tooltip" title="ویرایش">
                                    <button class="edit-margin edit btn btn-default btn-xs" data-id="{{:id}}"><span class="fa fa-pencil"></span></button>
                                </span>
                            </td>
                            <td class="txt-al-c">
                                <a href="/internalOrder/ordersheet/{{:id}}" class="btn btn-default btn-xs" data-toggle="tooltip" title="چاپ" data-title="چاپ"><i class="fa fa-print" aria-hidden="true"></i></a>
                                @*<button class="operation btn btn-default btn-xs" data-toggle="tooltip" title="عملیات" data-title="عملیات" data-id="{{:id}}"><span class="fa fa-cogs"></span></button>*@
                            </td>
                            @*<td class="txt-al-c hidden-sm hidden-md">
                                    <button class="setLog btn btn-default btn-xs" data-toggle="tooltip" title="درج توضیحات" data-title="درج توضیحات" data-id="{{:id}}"><span class="fa fa-comment"></span></button>
                                </td>*@
                            <td>
                                <button class="delete btn btn-default btn-xs" data-toggle="tooltip" title="حذف" data-title="حذف" data-id="{{:id}}"><span class="fa fa-close"></span></button>
                            </td>

                            <td class="txt-al-c">
                                <button class="status-log-history btn btn-default btn-xs" data-toggle="tooltip" title="سوابق" data-title="سوابق" data-id="{{:id}}"><span class="fa fa-file"></span></button>
                            </td>

                            <td class="txt-al-c">
                                <a href="/internalOrder/view/{{:id}}" class="btn btn-default btn-xs" data-toggle="tooltip" title="مشاهده" data-title="مشاهده"><i class="fa fa-eye" aria-hidden="true"></i></a>
                            </td>
                        </text>
                    }
                    @* <td class="txt-al-c">
                            <button class="send btn btn-success btn-xs" data-title="ارسال" data-id="{{:id}}"><span class="mdi-set mdi-send"></span></button>
                        </td>
                        <td>
                            <button class="cancel btn btn-danger btn-xs" data-title="لغو" data-id="{{:id}}"><span class="mdi-set mdi-close"></span></button>
                        </td>*@
                </tr>
                {{if description}}
                <tr>
                    <td class="description" colspan="22" style="color: blue;">
                        توضیحات: {{:description}}
                    </td>
                </tr>
                {{/if}}

                {{for log}}

                <tr class="">
                    <td colspan="20" style="color: rebeccapurple;" class="log">
                        {{:user}} <sub>{{:createdDate}}</sub>: <span class="html">{{:text}}</span>
                    </td>
                </tr>

                {{/for}}
                {{/for}}
            </tbody>
        </table>
        {{else}}
        <h4 class="txt-al-c">موردی یافت نشد</h4>
        {{/if}}
        <div class="clearfix"></div>
        <ul class="pagination pull-right">
            {{if page - 1 > 0}}
            <li><a href="#"><span class="mdi-set mdi-chevron-right mdi-18px bold"></span></a></li>
            {{/if}}
            {{if page - 4 > 0 && page + 1 >= pageCount}}
            <li><a class="page-number" href="#">{{:page - 4}}</a></li>
            {{/if}}
            {{if page - 3 > 0 && page + 2 >= pageCount}}
            <li><a class="page-number" href="#">{{:page - 3}}</a></li>
            {{/if}}
            {{if page - 2 > 0}}
            <li><a class="page-number" href="#">{{:page - 2}}</a></li>
            {{/if}}
            {{if page - 1 > 0}}
            <li><a class="page-number" href="#">{{:page - 1}}</a></li>
            {{/if}}
            <li class="active"><a class="page-number" href="#">{{:page}}</a></li>
            {{if page + 1 <= pageCount}}
            <li><a class="page-number" href="#">{{:page + 1}}</a></li>
            {{/if}}
            {{if page + 2 <= pageCount}}
            <li><a class="page-number" href="#">{{:page + 2}}</a></li>
            {{/if}}
            {{if page + 3 <= pageCount && page - 2 <= 0}}
            <li><a class="page-number" href="#">{{:page + 3}}</a></li>
            {{/if}}
            {{if page + 4 <= pageCount && page - 1 <= 0}}
            <li><a class="page-number" href="#">{{:page + 4}}</a></li>
            {{/if}}
            {{if page + 1 < pageCount}}
            <li><a href="#"><span class="mdi-set mdi-chevron-left mdi-18px bold"></span></a></li>
            {{/if}}
        </ul>
    </script>

    <script id="template-status" type="text/x-jsrender">
        {{if list != null && list.length > 0}}
        <table class="table">
            <thead>
                <tr>
                    @*<th>وضعیت</th>*@
                    <th>کاربر ثبت کننده</th>
                    <th>شعبه</th>
                    <th>تاریخ</th>
                </tr>
            </thead>
            <tbody>
                {{for list}}
                <tr style="border-top: solid 1px silver">
                    @*<td>{{:statusTitle}}</td>*@
                    <td>{{:userName}}</td>
                    <td>{{:branchName}}</td>
                    <td class="txt-al-c">{{:persianDate}}</td>
                </tr>
                {{/for}}
            </tbody>
        </table>
        {{else}}
        <h5>سوابقی برای این سفارش یافت نشد</h5>
        {{/if}}
    </script>

    <script id="template-getLog" type="text/x-jsrender">
        {{if list != null && list.length > 0}}
        <table class="table">
            <thead>
                <tr>
                    @*<th>وضعیت</th>*@
                    <th>نام مشتری</th>
                    <th>شماره تلفن</th>
                    <th>شعبه ثبت کننده</th>
                    <th>شعبه تحویل گیرنده</th>
                    <th>تاریخ</th>
                    <th>کد پیگیری</th>
                </tr>
            </thead>
            <tbody>
                {{for list}}
                <tr style="border-top: solid 1px silver">
                    <td>{{:status}}</td>
                    <td>{{:customerName}}</td>
                    <td>{{:phoneNumber}}</td>
                    <td>{{:branchName}}</td>
                    <td>{{:deliveredBranchName}}</td>
                    <td class="txt-al-l">{{:date}}</td>
                    <td>
                        {{if status == "ارسال به دفتر مرکزی" || status == "تحویل از شعبه" || status == "ارسال به شعبه" || status == "تحویل از دفتر مرکزی" }}
                        ---
                        {{else}}
                        {{:trackCode}}
                        {{/if}}
                    </td>
                </tr>
                {{/for}}
            </tbody>
        </table>
        {{else}}
        <h5>سوابقی برای این سفارش یافت نشد</h5>
        {{/if}}
    </script>

</body>

</html>

